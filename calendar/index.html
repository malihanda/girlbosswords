<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="stylesheet" href="calendar-styles.css">
</head>
<body>
    <div id="chart-container"></div>
    <div id="tooltip" class="tooltip"></div>
    <div id="details-panel" class="details-panel">
        <div class="details-panel-header"></div>
        <div class="details-panel-content"></div>
    </div>
    <script type="module">
        import { 
            showDetailsPanel, 
            hideDetailsPanel, 
            handleUrlHash,
            handleOutsideClick
        } from './filters-and-details.js';
        import { CalendarChart } from './chart.js';
        import { FilterSystem, populateFilterControls } from './filter-system.js';

        const colorConditions = [
            {
                // Misc entries get color-4 (highest priority)
                condition: (date) => date.records.some(r => r.category === 'misc'),
                colorClass: 'color-4'
            },
            {
                // Full-size or oversized puzzles get color-3
                condition: (date) => date.records.some(r => r.category === 'puzzle' && 
                    (r.size === 'full-size' || r.size === 'oversized')),
                colorClass: 'color-3'
            },
            {
                // Any records get color-2
                condition: (date) => date.records.length > 0,
                colorClass: 'color-2'
            },
            {
                // Default gets color-1 (lowest priority)
                condition: () => true,
                colorClass: 'color-1'
            }
        ];

        const tooltipTemplate = (date) => 
            `<strong>${date.date}</strong>\n${
                date.records
                    .filter(r => r.category === 'misc')
                    .map(item => `<strong>${item.publication}</strong> [${item.type}]: ${item.title}`)
                    .join('\n')
            }${
                date.records.filter(r => r.category === 'misc').length > 0 && 
                date.records.filter(r => r.category === 'puzzle').length > 0 ? '\n' : ''
            }${
                date.records
                    .filter(r => r.category === 'puzzle')
                    .map(puzzle => `<strong>${puzzle.publication}</strong>: ${puzzle.title}${
                        puzzle.collaborator ? ` with ${puzzle.collaborator}` : ''
                    } (${puzzle.size}, ${puzzle.style})`)
                    .join('\n')
            }`;

        // Initialize the chart with options
        const chart = new CalendarChart("chart-container", {
            colorConditions: colorConditions,
            tooltipTemplate: tooltipTemplate
        });
        
        // Load and render initial data
        await chart.loadData('data.json');
        chart.render();

        // Initialize filter system
        const filterSystem = new FilterSystem(chart.data);

        // Create filter controls
        populateFilterControls(chart.container, filterSystem, () => {
            // Get filtered data
            const filteredData = filterSystem.getFilteredData();
            
            // Update chart with filtered data
            chart.data = filteredData;
            chart.render();

            // Update filter counts
            const newCounts = filterSystem.getFilterCounts();

            // Update the count numbers in dropdowns
            document.querySelectorAll('.dropdown-option').forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (!checkbox) return;

                // console.log('Checkbox ID:', checkbox.id); // Keep console logs or remove as needed
                const [category, ...valueParts] = checkbox.id.split('-');
                const value = valueParts.join('-'); 
                // console.log('Split into:', { category, value });

                const countForOption = newCounts[category] ? (newCounts[category].get(value) || 0) : 0;
                // console.log('Count for', value, ':', countForOption);

                const label = option.querySelector('label');
                if (label) {
                    label.textContent = `${value} (${countForOption})`;
                }

                option.classList.toggle('disabled', countForOption === 0);
            });
        });

        // Set up details panel handling
        chart.container.addEventListener('cellClick', (e) => {
            const { date, records } = e.detail;
            showDetailsPanel(date, records);
        });

        // Set up hash change handling
        window.addEventListener("popstate", () => handleUrlHash(chart.data));

        // Handle outside clicks
        document.addEventListener("click", handleOutsideClick);

        // Check hash on initial load
        handleUrlHash(chart.data);
    </script>
</body>
</html> 